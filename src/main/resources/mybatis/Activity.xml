<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Activity">

	<resultMap id="MusicLikeResult" type="MusicLike">
		<result property="music_like_sq" column="music_like_sq"/>
		<result property="target_sq" column="target_sq"/>
		<result property="member_sq" column="member_sq"/>
		<result property="music_like_type" column="music_like_type"/>
	</resultMap>
	
	<!-- 최우일 -->
	<resultMap type="hashMap" id="replyMap">
		<id property="time_stamp" column="time_stamp"/>
		<result property="reply_sq" column="reply_sq" />
		<result property="member_sq" column="member_sq" />
		<result property="nick" column="nick" />
		<result property="reply_comment" column="reply_comment" />
	</resultMap>


	<!--JAN 1. 좋아요 눌렀을때 실행되는 메소드 -->
	<insert id="like">
		INSERT INTO music_like(
			music_like_sq,member_sq,target_sq,music_like_type
		) VALUES (
			music_like_sq.NEXTVAL,#{target_sq}, #{member_sq},#{music_like_type}
		)
	</insert>
	
	<!--JAN 좋아요 목록 -->
	<select id="likeList" resultType="MusicLike">
		
			
			
	
	</select>
	
	<!--JAN 좋아요 동일 시퀀스 레코드체크 -->
	<select id="likeCount" resultType="int">
		SELECT COUNT(*)
		FROM music_like
		WHERE member_sq = #{member_sq}
		AND target_sq = #{target_sq}
	</select>
	
	<!--JAN unlike -->
	<delete id="likeCancel">
		DELETE FROM music_like
		WHERE music_like_sq = #{music_like_sq}
	
	</delete>
	
	<!--JAN  -->
	<update id="like_check" parameterType="HashMap">
		UPDATE music_like
		SET music_like_sq = music_like_sq + 1
		WHERE member_sq=#{member_sq} AND target_sq=#{target_sq}
	</update>
	<!--JAN  -->
	<update id="like_check_cancel" parameterType="HashMap">
		UPDATE music_like
		SET music_like_sq = 0
		WHERE member_sq=#{member_sq} AND target_sq=#{target_sq}
	</update>

	<!-- PHmaruho -->
	<select id="selectAlbumType" resultType="Code">
		SELECT *
		FROM code
		WHERE CODE_CATEGORY = 'AT'
	</select>
	
	<select id="selectMusicTag" resultType="Tag">
		select *
		from tag
		start with TAG_CATEGORY is null
		CONNECT BY PRIOR TAG_CD = TAG_CATEGORY
	</select>
	
	<!-- 최우일 -->
	<select id="selectMusicDetail" parameterType="int" resultType="hashMap">
		select m.*, a.*, a.music_sq album_music_sq from music m, album a where m.music_sq = #{sq} and m.album_sq = a.album_sq
	</select>
	
	<!-- 최우일 -->
	<select id="selectMusicArtists" parameterType="int" resultType="Member">
		select m.* from artist a, member m where a.music_sq = #{sq} and a.member_sq = m.member_sq
	</select>
	
	<!-- 최우일 -->
	<select id="selectReplyAtMusic" parameterType="int" resultMap="replyMap">
		select r2.time_stamp, member_sq, nick, reply_comment
		from (
		  select min(reply_sq) reply_sq, time_stamp
		  from reply
		  where music_sq = #{sq} group by time_stamp) r1, (
		  
		  select r.reply_sq, r.time_stamp, m.member_sq, m.nick, r.reply_comment
		  from member m, reply r
		  where r.music_sq = #{sq} and r.member_sq = m.member_sq) r2
		where r1.reply_sq = r2.reply_sq
		order by r2.time_stamp
	</select>
</mapper>
